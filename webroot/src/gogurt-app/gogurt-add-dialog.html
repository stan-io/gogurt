<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="gogurt-app-data.html">

<dom-module id="gogurt-add-dialog">
  <template>
    <gogurt-app-data key="userInfoData" data="{{userInfo}}"></gogurt-app-data>
    <paper-dialog id="dialog" modal style="width: 500px; padding: 20px;">
      <h2>Add</h2>
      <paper-dialog-scrollable>
        <form is="iron-form" id="form" method="put" on-iron-form-presubmit="submitForm" action="/api/add/new">
          <input type="file" id="fileInput" on-change="fileChange" hidden>
          <paper-input id="fileDisplay" label="File" readonly>
            <paper-button suffix onclick="fileInput.click()">Choose</paper-button>
          </paper-input>
          <paper-input id="fileTag" label="Tag"></paper-input>
        </form>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss onclick="form.reset();">Cancel</paper-button>
        <paper-button dialog-confirm autofocus onclick="form.submit(); form.reset();">Add</paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'gogurt-add-dialog',
      properties: { userInfo: Object },
      listeners: {
        'fileChange': 'fileChange'
      },
      open: function(e) {
        this.$.dialog.open();
      },
      fileChange: function(e) {
        if (this.$.fileInput.files.length > 0) {
          this.$.fileDisplay.value = this.$.fileInput.files[0].name;
        } else {
          this.$.fileDisplay.value = "";
        }
      },
      submitForm: function(e) {
        e.preventDefault();

        var xhr = new XMLHttpRequest();
        var Name = this.$.fileInput.files[0].name;
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            var response = JSON.parse(xhr.responseText);
            var toast = document.querySelector("#toast");
            if (xhr.status === 200 && response.status === 'OK') {
              toast.text = "Added " + Name + " to the queue.";
            } else {
              toast.text = "Failed: " + xhr.responseText;
            }
            toast.open();
          }
        }
        xhr.open('put', "/api/add/new", true);
        var formData = new FormData();
        formData.append("fileInput", this.$.fileInput.files[0]);
        formData.append("fileTag", this.$.fileTag.value);
        xhr.setRequestHeader("Authorization", this.userInfo.token)
        xhr.send(formData);
      }
    });
  </script>
</dom-module>